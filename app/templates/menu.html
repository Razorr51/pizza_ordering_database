{% extends "base.html" %}

{% block head_styles %}
  <style>
    .wrap { max-width: 1080px; margin: 32px auto; padding: 0 16px; }
    h1 { font-size: 32px; margin: 0 0 8px; }
    .sub { color: var(--muted); margin-bottom: 18px; }
    .note { color: var(--muted); font-size: 13px; margin-bottom: 22px; }
    .section { margin-top: 28px; }
    .category { font-size: 20px; margin: 12px 0 10px; }
    .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(240px, 1fr)); gap: 16px; }
    .card { background: radial-gradient(1100px 300px at 0% 0%, rgba(77,88,121,0.18), transparent), var(--card);
            border: 1px solid rgba(100,116,139,0.2); border-radius: 16px; padding: 16px; box-shadow: 0 10px 25px rgba(0,0,0,0.25); }
    .title { font-weight: 600; font-size: 18px; margin: 0 0 4px; }
    .muted { color: var(--muted); font-size: 13px; min-height: 32px; }
    .price { margin-top: 12px; font-weight: 700; font-size: 18px; }
    .pills { display: flex; gap: 8px; flex-wrap: wrap; margin-top: 10px; }
    .pill { font-size: 12px; padding: 4px 10px; border-radius: 999px; background: #21304d; border: 1px solid rgba(100,116,139,0.35); }
    .pill.veg  { border-color: rgba(110,231,183,0.8); color: var(--accent); }
    .pill.vege { border-color: rgba(251,191,36,0.8); color: var(--warning); }
    .searchbar { margin: 12px 0 24px; }
    .searchbar input { width: 100%; padding: 12px 14px; border-radius: 10px; border: 1px solid rgba(100,116,139,0.35); background: #0f1629; color: var(--text); outline: none; }
    .qty-inline { margin-top: 14px; display: flex; align-items: center; gap: 10px; justify-content: center; }
    .qty-inline .qty-btn { width: 32px; height: 32px; border-radius: 50%; border: none; background: linear-gradient(135deg,#2563eb,#38bdf8); color: white; font-weight: 700; cursor: pointer; display:flex; align-items:center; justify-content:center; transition: transform .1s ease; }
    .qty-inline .qty-btn.secondary { background: rgba(148,163,184,0.25); color: var(--text); }
    .qty-inline .qty-btn:hover { transform: translateY(-1px); }
    .qty-inline .qty-badge { min-width: 34px; text-align: center; font-weight: 600; font-size: 15px; }
    .extras-block { margin-top: 12px; }
    .extras-heading { font-size: 18px; margin: 16px 0 10px; }
    .cart-bar { position: fixed; left: 50%; transform: translateX(-50%); bottom: 24px; display: flex; align-items: center; gap: 16px;
                background: rgba(15,23,42,0.92); border: 1px solid rgba(148,163,184,0.3); border-radius: 999px; padding: 12px 20px;
                box-shadow: 0 18px 40px rgba(15,23,42,0.45); backdrop-filter: blur(12px); }
    .cart-bar button { border: none; border-radius: 999px; padding: 10px 18px; font-weight: 600; cursor: pointer; }
    .cart-bar button.primary { background: linear-gradient(135deg,#22c55e,#3b82f6); color: white; }
    .cart-bar button.secondary { background: rgba(148,163,184,0.15); color: var(--text); }
    .cart-message { margin-top: 14px; font-size: 14px; }
    .cart-message.error { color: #f87171; }
    .cart-message.success { color: #34d399; }
    @media (max-width: 640px) {
      .cart-bar { flex-wrap: wrap; justify-content: center; }
    }
  </style>
{% endblock %}

{% block content %}
  <div class="wrap">
    <h1>üçï Alibrandi's Menu</h1>
    <div class="sub">Tap any item to add it to your cart.</div>

    <div class="searchbar">
      <input placeholder="Search pizzas, drinks, desserts, or ingredients‚Ä¶" oninput="onSearch(this)" />
    </div>
    <div class="note">
      {% if session.get('customer_id') %}
        Logged in as <strong>{{ session.get('customer_name') }}</strong>. Orders will ship to your saved address.
      {% else %}
        Ready to order? <a href="{{ url_for('auth.signup_form') }}">Create an account</a> or <a href="{{ url_for('auth.login_form') }}">log in</a> so we can deliver to you.
      {% endif %}
    </div>

    <div class="section">
      <div class="category">Pizzas</div>
      <div class="grid">
        {% for p in pizzas %}
          <div class="card" data-item data-kind="pizza" data-id="{{ p.pizza_id }}" data-name="{{ p.pizza_name }}" data-price="{{ '%.2f'|format(p.final_price|float) }}" data-ing="{{ p.ingredients or '' }}">
            <div class="title">{{ p.pizza_name }}</div>
            <div class="muted">{{ p.ingredients or '‚Äî' }}</div>
            <div class="pills">
              {% if p.is_vegan %}<span class="pill veg">vegan</span>{% endif %}
              {% if p.is_vegetarian and not p.is_vegan %}<span class="pill vege">vegetarian</span>{% endif %}
            </div>
            <div class="price">‚Ç¨ {{ '%.2f'|format(p.final_price|float) }}</div>
            <div class="qty-inline">
              <button type="button" class="qty-btn secondary" data-action="decrement">‚àí</button>
              <span class="qty-badge" data-qty-value>0</span>
              <button type="button" class="qty-btn" data-action="increment">+</button>
            </div>
          </div>
        {% endfor %}
      </div>
    </div>

    {% if drinks %}
      <div class="section">
        <div class="category">Drinks</div>
        <div class="grid">
          {% for d in drinks %}
            <div class="card" data-item data-kind="drink" data-id="{{ d.item_id }}" data-name="{{ d.name }}" data-price="{{ '%.2f'|format(d.final_price|float) }}">
              <div class="title">{{ d.name }}</div>
              <div class="pills">
                {% if d.is_vegan %}<span class="pill veg">vegan</span>{% endif %}
                {% if d.is_vegetarian and not d.is_vegan %}<span class="pill vege">vegetarian</span>{% endif %}
              </div>
              <div class="price">‚Ç¨ {{ '%.2f'|format(d.final_price|float) }}</div>
              <div class="qty-inline">
                <button type="button" class="qty-btn secondary" data-action="decrement">‚àí</button>
                <span class="qty-badge" data-qty-value>0</span>
                <button type="button" class="qty-btn" data-action="increment">+</button>
              </div>
            </div>
          {% endfor %}
        </div>
      </div>
    {% endif %}

    {% if desserts %}
      <div class="section">
        <div class="category">Desserts</div>
        <div class="grid">
          {% for d in desserts %}
            <div class="card" data-item data-kind="dessert" data-id="{{ d.item_id }}" data-name="{{ d.name }}" data-price="{{ '%.2f'|format(d.final_price|float) }}">
              <div class="title">{{ d.name }}</div>
              <div class="pills">
                {% if d.is_vegan %}<span class="pill veg">vegan</span>{% endif %}
                {% if d.is_vegetarian and not d.is_vegan %}<span class="pill vege">vegetarian</span>{% endif %}
              </div>
              <div class="price">‚Ç¨ {{ '%.2f'|format(d.final_price|float) }}</div>
              <div class="qty-inline">
                <button type="button" class="qty-btn secondary" data-action="decrement">‚àí</button>
                <span class="qty-badge" data-qty-value>0</span>
                <button type="button" class="qty-btn" data-action="increment">+</button>
              </div>
            </div>
          {% endfor %}
        </div>
      </div>
    {% endif %}

    {% if other_extras %}
      <div class="section extras-block">
        {% for label, items in other_extras.items() %}
          <div class="extras-heading">{{ label.title() }}</div>
          <div class="grid">
            {% for item in items %}
              <div class="card" data-item data-name="{{ item.name }}">
                <div class="title">{{ item.name }}</div>
                <div class="pills">
                  {% if item.is_vegan %}<span class="pill veg">vegan</span>{% endif %}
                  {% if item.is_vegetarian and not item.is_vegan %}<span class="pill vege">vegetarian</span>{% endif %}
                </div>
                <div class="price">‚Ç¨ {{ '%.2f'|format(item.final_price|float) }}</div>
              </div>
            {% endfor %}
          </div>
        {% endfor %}
      </div>
    {% endif %}
  </div>

  <div id="cart-bar" class="cart-bar" hidden>
    <span id="cart-summary">Cart empty</span>
    <button type="button" class="secondary" onclick="viewCart()">View cart</button>
    <button type="button" class="primary" onclick="checkoutCart()">Checkout</button>
  </div>
  <div id="cart-message" class="cart-message"></div>

  <script>
    function onSearch(input){
      const q = input.value.toLowerCase();
      document.querySelectorAll('[data-item]').forEach(card => {
        const text = (card.dataset.name + ' ' + (card.dataset.ing || '')).toLowerCase();
        card.style.display = text.includes(q) ? '' : 'none';
      });
    }

    const LOGGED_IN_CUSTOMER = {{ session.get('customer_id') or 'null' }};
    const basket = { pizzas: {}, drinks: {}, desserts: {} };

    const KIND_MAP = { pizza: 'pizzas', drink: 'drinks', dessert: 'desserts' };

    function bucketKey(kind){
      return KIND_MAP[kind] || null;
    }

    function getQuantity(kind, id){
      const key = bucketKey(kind);
      if(!key){ return 0; }
      const item = basket[key][id];
      return item ? item.quantity : 0;
    }

    function adjustCart(kind, id, name, price, delta){
      const key = bucketKey(kind);
      if(!key){ return; }
      const bucket = basket[key];
      let item = bucket[id];
      if(!item && delta > 0){
        item = bucket[id] = { id: Number(id), name, quantity: 0, price: Number(price) || 0 };
      }
      if(!item){
        showMessage('Nothing to remove yet.', true);
        return;
      }
      item.quantity += delta;
      if(item.quantity <= 0){
        delete bucket[id];
      }
      renderCartBar();
      updateCardQuantity(kind, id);
      const qty = getQuantity(kind, id);
      const msg = delta > 0 ? `${name} in cart: ${qty}` : `${name} updated: ${qty}`;
      showMessage(msg, false);
    }

    function cartCount(){
      return [basket.pizzas, basket.drinks, basket.desserts]
        .flatMap(Object.values)
        .reduce((acc, item) => acc + item.quantity, 0);
    }

    function cartTotal(){
      return [basket.pizzas, basket.drinks, basket.desserts]
        .flatMap(Object.values)
        .reduce((acc, item) => acc + item.quantity * (item.price || 0), 0);
    }

    function renderCartBar(){
      const bar = document.getElementById('cart-bar');
      const summary = document.getElementById('cart-summary');
      const count = cartCount();
      if(count === 0){
        bar.hidden = true;
        summary.textContent = 'Cart empty';
        return;
      }
      bar.hidden = false;
      const total = cartTotal();
      summary.textContent = `${count} item${count === 1 ? '' : 's'} | ‚Ç¨ ${total.toFixed(2)}`;
    }

    function updateCardQuantity(kind, id){
      const card = document.querySelector(`[data-item][data-kind="${kind}"][data-id="${id}"]`);
      if(!card){ return; }
      const valueEl = card.querySelector('[data-qty-value]');
      if(valueEl){
        valueEl.textContent = getQuantity(kind, id);
      }
    }

    function updateAllCardQuantities(){
      document.querySelectorAll('[data-item]').forEach(card => {
        updateCardQuantity(card.dataset.kind, card.dataset.id);
      });
    }

    function viewCart(){
      const lines = [];
      const push = (bucket, label) => {
        Object.values(bucket).forEach(item => {
          if(item.quantity > 0){
            lines.push(`${item.quantity} √ó ${item.name} (${label}) - ‚Ç¨ ${(item.price * item.quantity).toFixed(2)}`);
          }
        });
      };
      push(basket.pizzas, 'pizza');
      push(basket.drinks, 'drink');
      push(basket.desserts, 'dessert');
      if(lines.length === 0){
        showMessage('Your cart is empty.', true);
        return;
      }
      const total = cartTotal();
      showMessage(`${lines.join('; ')} | Total: ‚Ç¨ ${total.toFixed(2)}`, false);
    }

    async function checkoutCart(){
      if(cartCount() === 0){
        showMessage('Add items before checking out.', true);
        return;
      }
      if(!LOGGED_IN_CUSTOMER){
        showMessage('Please create an account before checking out. Redirecting‚Ä¶', true);
        setTimeout(() => {
          window.location.href = '{{ url_for("auth.signup_form") }}?next={{ url_for("menu.get_menu_html") }}';
        }, 1200);
        return;
      }

      const payload = {
        pizzas: Object.values(basket.pizzas).map(({ id, quantity }) => ({ pizza_id: id, quantity })),
        drinks: Object.values(basket.drinks).map(({ id, quantity }) => ({ item_id: id, quantity })),
        desserts: Object.values(basket.desserts).map(({ id, quantity }) => ({ item_id: id, quantity }))
      };

      try {
        const response = await fetch('/orders/', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        const data = await response.json();
        if(!response.ok){
          const message = data.errors ? Object.values(data.errors).join(' ') : (data.message || 'Could not place your order.');
          showMessage(message, true);
          if(response.status === 401){
            setTimeout(() => window.location.href = '{{ url_for("auth.signup_form") }}?next={{ url_for("menu.get_menu_html") }}', 1200);
          }
          return;
        }
        const orderId = data.order_id || data.order?.order_id || 'new';
        const totalDue = data?.totals && data.totals.total_due !== undefined ? Number(data.totals.total_due) : cartTotal();
        showMessage(`Order #${orderId} confirmed! Total ‚Ç¨ ${totalDue.toFixed(2)}. We\'ll use your saved address.`, false, true);
        basket.pizzas = {};
        basket.drinks = {};
        basket.desserts = {};
        renderCartBar();
        updateAllCardQuantities();
      } catch (err){
        console.error(err);
        showMessage('Unexpected error placing the order. Please try again.', true);
      }
    }

    function showMessage(message, isError = false, isSuccess = false){
      const el = document.getElementById('cart-message');
      el.textContent = message;
      el.className = `cart-message ${isError ? 'error' : isSuccess ? 'success' : ''}`;
    }

    document.addEventListener('click', evt => {
      const btn = evt.target.closest('[data-action]');
      if(!btn){ return; }
      const action = btn.dataset.action;
      if(action !== 'increment' && action !== 'decrement'){ return; }
      const card = btn.closest('[data-item]');
      if(!card){ return; }
      const delta = action === 'increment' ? 1 : -1;
      adjustCart(card.dataset.kind, card.dataset.id, card.dataset.name, card.dataset.price, delta);
    });

    renderCartBar();
    updateAllCardQuantities();
  </script>
{% endblock %}
